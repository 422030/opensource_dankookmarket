<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>êµì¬ ê²€ìƒ‰</title>
  <link rel="stylesheet" href="../src/css/styles.css" />
<style>
  * {
    box-sizing: border-box;
  }

  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background-color: #f9f8f4;
    font-family: 'Courier New', monospace;
  }

  nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background-color: #3661e1;
    color: white;
  }

  nav ul {
    list-style: none;
    display: flex;
    gap: 15px;
    margin: 0;
    padding: 0;
  }

  nav a {
    color: white;
    text-decoration: none;
    font-size: 16px;
  }


  img {
    max-width: 100px;
    margin-top: 5px;
    display: block;
  }
  main input,
  main select,
  main button {
    font-size: 16px;
    padding: 10px 14px;
    margin: 6px;
  }

  h2 {
    font-size: 24px;
  }
  button {
    padding: 10px 20px;
    font-size: 16px;
    border: 1px solid #aaa;
    border-radius: 6px;
    background-color: white;
    cursor: pointer;
    transition: 0.2s;
  }

  button:hover {
    background-color: #3661e1;
    color: white;
    border-color: #3661e1;
  }

</style>
</head>
<body>
  <header>
    <nav>
      <a href="index.html"><img src="logo.png" alt="ë¡œê³ " /></a>
      <ul>
        <li><a href="index.html">í™ˆ</a></li>
        <li><a href="search_book.html">êµì¬ ê²€ìƒ‰</a></li>
        <li><a href="add_book.html">êµì¬ ë“±ë¡</a></li>
        <li><a href="group_buy.html">ê³µë™êµ¬ë§¤</a></li>
        <li>
         <a href="chat_box.html" title="ì±„íŒ…í•¨" class="chat-button">
           <div class="chat-icon"></div>
           <span class="chat-label">ì±„íŒ…ì°½</span>
         </a>
        </li>
      </ul>
    </nav>
  </header>

 <main style="display: flex; flex-direction: column; align-items: center; text-align: center; padding: 30px; font-size: 18px;">
    <h2>êµì¬ ê²€ìƒ‰</h2>
    <input id="searchInput" placeholder="êµì¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" />
    <select id="categoryFilter">
      <option value="all">ì „ì²´</option>
      <option value="ì „ê³µ">ì „ê³µ</option>
      <option value="êµì–‘">êµì–‘</option>
    </select>
    <button onclick="searchBooks()">ê²€ìƒ‰</button>

    <div id="resultArea"></div>
  </main>

  <footer style="text-align: center;">
    <p>&copy; 2025 ë‹¨ê·¼ë§ˆì¼“</p>
  </footer>
 
 <script>
    const username = localStorage.getItem("username");
    if (!username) {
      alert("ë¡œê·¸ì¸ ë¨¼ì € í•´ì£¼ì„¸ìš”.");
      window.location.href = "index.html";
    }


    let books = [];

    async function fetchBooksFromAPI() {
      try{
        const response = await fetch("http://127.0.0.1:8000/api/books/");
        if (!response.ok) {
          throw new Error("ì±… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
        books = await response.json();
        searchBooks();
      } catch (error) {
        console.error("API ì—ëŸ¬:", error);
      }
    }

    function searchBooks() {
      const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
      const category = document.getElementById("categoryFilter").value;
      const resultArea = document.getElementById("resultArea");

      const results = books.filter(book =>
        (book.title.toLowerCase().includes(keyword) || book.description?.toLowerCase().includes(keyword)) &&
        (category === "all" || book.category === category)
  );

  if (results.length === 0) {
    resultArea.innerHTML = "<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  resultArea.innerHTML = results.map((book, i) => `
  <div style="border:1px solid #ccc; padding:10px; margin:10px 0;">
    ${i + 1}. <strong>${book.title}</strong> (${book.category}) - ${book.price}ì›<br/>
    ğŸ’¬ ${book.description || "ì„¤ëª… ì—†ìŒ"}<br/>
    ğŸ‘¤ ë“±ë¡ì: ${book.seller_username}

    ${book.seller_username !== username ? `
      <div style="text-align: center; margin-top: 10px;">
        <button style="display: inline-block;" onclick="startChat('${book.seller_username}')">ğŸ’¬ ì±„íŒ…í•˜ê¸°</button>
      </div>
    ` : ""}

    <div style="text-align: center; margin-top: 6px;">
      <button style="display: inline-block;" onclick="location.href='book_detail.html?id=${book.id}'">ğŸ“– ìƒì„¸ë³´ê¸°</button>
    </div>
  </div>
`).join("");

}


    function startChat(target) {
      const message = prompt(`${target}ë‹˜ì—ê²Œ ë³´ë‚¼ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
      if (message) {
        const key = `chat_${username}_to_${target}`;
        const history = JSON.parse(localStorage.getItem(key) || "[]");
        history.push({ from: username, to: target, message, time: new Date().toLocaleString() });
        localStorage.setItem(key, JSON.stringify(history));
        alert("ë©”ì‹œì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤!");
      }
    }

    window.addEventListener("DOMContentLoaded", fetchBooksFromAPI);
  </script>
</body>
</html>
